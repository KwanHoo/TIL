# JWT

#JWT, #cookie, #SMTP, #OAuth, #Nginx

### JWT란?

- JSON Web Token
- 인증을 위한 정보를 특별한 저장소를 이용하지 않고, 전자 서명을 이용하여 확인하는 방법

- 즉, JWT는 서버와 클라이언트 간 정보를 주고 받을때 HTTP Request Header에 넣어 주는 JSON 토큰을 말함
- 토큰을 사용하여 서버는 별도의 인증 과장 없이 토큰 정보만으로 인증을 처리할 수 있게 됨

### JWT 사용 이유

#### 보안 이슈

- 쿠키 또는 세션을 탈취하여 발생하는 보안 이슈를 막을 수 있음
- JWT는 쿠키를 사용하지 않기 떄문에, Cross-Origin Resource Sharing(CORS) 이슈가 발생하지 않음

#### 데이터 용량

- JWT는 기존의 XML 보다 덜 복잡하고 인코딩 된 사이즈가 작음
- HTTP와 HTML 환경에서 사용하기 좋음

#### 사용성

- 서버 확장시 토큰 정보만 공유하면 새롭게 추가된 서버에서도 바로 사용할 수 있으니 확장성에 용이함
- 토큰 기반으로 하는 다른 인증 시스템과 상호 호환이 가능함
- 토큰에 필요한 별도의 저장소 관리를 할 필요가 없음

### JWT의 구성

- header : 토큰의 타입 (jwt), 데이터 서명 방식
- payload : 전달되는 데이터
- signature : 헤더와 페이로드의 전자서명

- JWT는 web token, 데이터를 웹에서 사용하기 위한 스펙이므로 웹에서 문제없이 사용할 수 있는 문자열로만 구성된 base64 인코딩을 사용

### JWT와 보안

- JWT의 payload는 단순히 정보를 base64encode -> decode 시 정보 노출됨 -> 민감한 정보는 제외하고 토큰 생성 필수

- 서버는 JWT를 생성할 때, 비공개키를 이용하여 서명을 함
- payload를 조작할 경우 서명이 일치하지 않기 때문에 인증 실패

### JWT 작동 방식

1. 사용자 로그인
2. 서버는 로그인된 유저 정보를 JWT로 생성하여 클라이언트에 전달
3. 클라이언트는 전달받은 JWT를 이용하여 인증이 필요한 요청에 사용

### JWT 사용 이용

- Session은 기본적으로 웹 브라우저의 통신 스펙
- 모바일 앱 등, 웹 브라우저가 아닌 어플리케이션의 경우 이를 활용하기 부적합함
- JWT를 사용하면 어느 클라이언트에서나 동일한 방식의 사용자 인증을 구현 가능

### Cookie란?

- 웹 서비스에서 사용하는 정보를 클라이언트에 저장하고, HTTP 요청시 이를 함께 전송하여, 클라이언트 정보를 서버에 전달하는 기술

### 세션 vs 쿠키

- 세션 : 클라이언트 정보를 서버 측 저장소에 저장하고 사용
- 쿠키 : 클라이언트 정보를 클라이언트 (브라우저)에 저장하고 사용

### JWT + 쿠키

- 세션을 사용한 유저 로그인의 경우
- 쿠키에 세션ID 저장 -> 세션 스토어에서 유저 정보 가져오기
- JWT를 쿠키에 저장하는 경우
- JWT로 요청 -> 서명 확인 후 유저 정보 사용
- 데이터베이스 접근이 줄어서 효율적인 인증 구현 가능

### JWT 로그인 구현하기

1. 기존 세션으로 구현된 로그인을 비활성화
2. 로그인 로직에서 JWT 생성 후 쿠키로 전달
3. passport-jwt 패키지로 jwt 로그인 미들웨어 작성 및 사용

### 회원 비밀번호 찾기 흐름

1. 임의의 문자열로 비밀번호 초기화
2. 초기화된 문자열을 메일로 전달 -> 메일 발송기능 개발 필요
3. 초기화 후 첫 로그인 시 비밀번호 변경 요청

### 메일 발송기능 구현 방법

- SMTP 서버 이용

  - 네이버 구글 등의 메일 서버를 이용하여 무료로 발송 가능
  - 메일 발송 및 관리 기능 직접 개발 필요

- 메일 발송 서비스 이용 (Mailgun, sendgrid...)
  - 메일 발송 api 제공 및 관리용 웹페이지 제공
  - 사용량에 따라 유로 과금

### SMTP란?

- Simple Mail Transfer Protocol
- 메일 전송을 위한 표준 규약
- SMTP 서버란 표준 규약을 통해 메일을 전송하는 기능을 구현한 서버

### Node.js에서 메일 발송하기

- Nodemailer 패키지를 사용하여 SMTP 서버를 통해 메일을 발송할 수 있음
- SMTP 서버를 직접 만들고 운영하는 것은 비효율적
- 메일 기능을 제공하는 서비스 제공자들은 SMTP 서버를 사용할 수 있게 제공함
  - eX) Gmail, Naver

### OAuth란?

- Open Authorization, Open Authentication
- 애플리케이션의 유저의 비밀번호를 Third pary 앱에 제공없이, 인증, 인가를 할 수 있는 오픈 스탠다드 프로토콜임
- 서비스 제공자가 다른 서비스에게 데이터를 제공하기 위해
- 서비스 사용자에게 제공하는 사용자 인증 방식의 표준
- Oauth 인증을 통해 애플리케이션 API를 유저 대신에 접근할 수 있는 권한을 얻을 수 있음

### OAuth 동작 방식

1. 서비스 제공자에게 인증 요청
2. 인증 완료 후 사용자 정보를 요청한 서비스로 전달
3. 인증 정보를 이용해 서비스 제공자 데이터 사용

### OAuth 사용 예시

- 구글 캘린더 연동 서비스

1. 구글 OAuth 인증 요청
2. 인증된 OAuth Token을 기록
3. OAuth Token을 사용하여 구글 캘린더 APi 사용

### OAuth와 로그인

- OAuth는 사용자의 인증을 제공하는 표준
- 이를 활용하여, 로그인 기능을 간편하게 구성할 수 있음
- 웹 서비스 제공자는 아이디, 비밀번호 로그인을 구현할 필요 없음
- 웹 서비스 사용자는 로그인 시 아이디, 비밀번호를 입력 할 필요 없음

### 구글 로그인 구현 순선

- 구글 클라우드 플랫폼 프로젝트 생성
- API 및 서비스 -> OAuth 동의화면 설정
- 사용자 인증정보 -> OAuth 클라이언트 ID 만들기
- passport-google-oauth20 연동

### Nginx란?

- 최근 신규 프로젝트에서 가장 많이 채택되고 있는 웹 서버 소프트웨어
- 웹 서버 소프트웨어란, HTTP 요청을 받아
- 파일이나 프로그램 실행 결과를 HTTP 응답으로 보내주는 소프트웨어

### Nginx를 사용하는 이유

- Java - Tomcat, PHP - fastcgi 등 다른 언어가 HTTP 요청 처리를 위한 의존성이 있는 것에 반해, Node.js는 기본적으로 HTTP 요청을 수신하고, 응답하는 기능이 이미 있음

  - 웹 서버 소프트웨어 없이도 스스로 동작 가능
    - 하지만, HTTPS, 도메인 연결, static file caching 등의 기능을 사용하기 위해 Nginx 같은 웹 서버 소프트웨어는 필수

- Node.js 단독으로 production-level 서비스를 구축할 수 없음

참고 : 엘리스
